<apex:page id="editPage" tabStyle="advpm__ActionPlan__c" standardController="advpm__ActionPlan__c" extensions="advpm.ActionPlanCreationController" standardStylesheets="true" sidebar="false">
<apex:outputPanel rendered="{!isLightning}">
    <apex:outputPanel rendered="{!advpm__ActionPlan__c.Id != null}">
        <script type="text/javascript">
            var ur = '{!URLFOR($Page.advpm__ActionPlanCreationSLDS,advpm__ActionPlan__c.Id,[id=advpm__ActionPlan__c.Id,clone=URLENCODE($CurrentPage.parameters.clone)])}';
            if ( (typeof sforce != 'undefined') && (sforce != null) ) {
                sforce.one.navigateToURL(ur, true);
            }
        </script>
    </apex:outputPanel>
    <apex:outputPanel rendered="{!advpm__ActionPlan__c.Id == null}">
        <script type="text/javascript">
            var ur = '{!URLFOR($Page.advpm__ActionPlanCreationSLDS,advpm__ActionPlan__c.Id,[id=advpm__ActionPlan__c.Id,clone=URLENCODE($CurrentPage.parameters.clone),templateId=URLENCODE($CurrentPage.parameters.templateId),refId=URLENCODE($CurrentPage.parameters.refId),refType=URLENCODE($CurrentPage.parameters.refType),relatedObjectSelected=URLENCODE($CurrentPage.parameters.relatedObjectSelected)])}';
            if ( (typeof sforce != 'undefined') && (sforce != null) ) {
                sforce.one.navigateToURL(ur, true);
            }
        </script>
    </apex:outputPanel>
</apex:outputPanel>
<apex:outputPanel rendered="{!!isLightning}">
    <script type="text/javascript">
        var AP_ITSELF_TASK_DEPENDENCY   = '{!$Label.advpm__ap_itselfdependencyerror}';
        var AP_REMOVE_CYCLIC_DEPENDENCY = '{!$Label.advpm__ap_error_cyclic_dependency_found}';
        var AP_LARGE_DAY_NUMBER         = '{!$Label.advpm__ap_errors_day_number_too_large}';
        var AP_TASKS_CONFIRM_MSG        = "{!$Label.advpm__ap_confirm_tasks_deletion}";
    </script>
    <apex:includeScript value="{!URLFOR($Resource.advpm__jQueryZip, 'js/jquery-1.8.3.min.js')}" />
    <apex:includeScript value="{!$Resource.advpm__ActionPlan_Utilities}" />
    <apex:includeScript value="{!$Resource.advpm__ActionPlan_ActionPlanCreationScripts}" />
    <apex:stylesheet value="{!$Resource.advpm__ActionPlan_ActionPlanCreationStyles}" />
    <style type="text/css">
        /*div.task_input_short select:first-child { display:none; }*/
        .editPage .detailList .helpOrb {position:relative;right: 0px;}
        .user_column { white-space:nowrap; }
        .user_column_child { 
            display:inline-block !important;
            *display:inline; /* for IE7*/
            *zoom:1;/* for IE7*/
            white-space:normal;
        }
        .task_input_short select { width:115px!important; }
        .task_input_short .lookupInput input { width:130px!important;vertical-align: top!important; }
        .user_column_child .userLookupFields select { width:134px!important; } 
        .taskTable td {padding: 3px 3px 2px 0px;}
        .taskTable th {vertical-align: bottom !important;}
        
.taskTable th.firstCol          {   width:1%;   }
.taskTable th.actTypeCol        {   width:6%;   }
.taskTable th.subjectCol        {   width:13%;  }
.taskTable th.dependencyColumn  {   width:13%;  }
.taskTable th.daysCol           {   width:4%;   }
.taskTable th.startTimeCol      {   width:6%;   }
.taskTable th.durationCol       {   width:6%;   }
.taskTable th.assigned_to_field {   width:10%;  }
.taskTable th.typeCol           {   width:8%;   }
.taskTable th.priorityCol       {   width:8%;   }
.taskTable th.sendMailCol       {   width:8%;   }
.taskTable th.reminderCol       {   width:11%;  }
.taskTable th.commentsCol       {   width:6%;   } 
/*
.taskTable th.firstN    {   width:3%;   }
.taskTable th.secondN   {   width:11%;  }
.taskTable th.thirdN    {   width:11%;  }
.taskTable th.fourthN   {   width:8%;   }
.taskTable th.fifthN    {   width:11%;  }
.taskTable th.sixthN    {   width:8%;   }
.taskTable th.septhN    {   width:8%;   }
.taskTable th.eigthN    {   width:6%;   }
.taskTable th.ninthN    {   width:12%;  }
.taskTable th.tenthN    {   width:5%;   }   
table.sortable  th div{
    float:left;
}*/

/*
.taskTable td.sixth select , .taskTable td.septh select , .taskTable td.third select {
    width:90%;
}
.taskTable td.ninth select {
    width:60%;
}
.taskTable td.fourth  .days_input{
    width: 75%;
}
.taskTable td.second .task_input_short{
    width: 80%;
}
.taskTable td.fifth .task_input_short{
    width: 70%;
}
*/
    </style>
    <script type="text/javascript">
        $(function(){
            ActionPlanCreationScripts.refreshItemDates();
            initAssignedToLookups();
        });
    </script>
    <script type="text/javascript">
        function initAssignedToLookups() {
            $( "div.user_column div.userLookupFields select[name$='userLookupFields']" ).each(function(i, elem) {
                // a javascript object to collect the elements in each region
                var userLookupFields = {};
                
                // iterate all of the options and collect them by region
                $('option', elem).each(function (i) {
                    if (i === 0) {
                        return; // skip the first element in the list
                    }
                    var oElement = $(this);
                    var fieldGroupHeader = oElement.text().split('_');
        
                    // create an array entry for the region name if there is not one
                    if (!userLookupFields[fieldGroupHeader[0]]) {
                        userLookupFields[fieldGroupHeader[0]] = [];
                    }
        
                    // add the item to the array for this region
                    userLookupFields[fieldGroupHeader[0]].push(oElement);
                });
        
                // iterate all of the names in the regions object
                for (var userLookupField in userLookupFields) {
        
                    // make sure the name did not come from the prototype
                    if (userLookupFields.hasOwnProperty(userLookupField)) {
        
                        // turn the array of items into a single jQuery collection
                        var groupElements = $(userLookupFields[userLookupField]).map(function () {
                            return this.toArray();
                        });
        
                        // create the group and set the label
                        var optgroup = $('<optgroup/>');
                        optgroup.attr('label', userLookupField);
        
                        // wrap the option elements in an optgroup
                        groupElements.wrapAll(optgroup);
        
                        // remove the region text from the label
                        groupElements.each(function () {
                            $(this).text(function () {
                                return $(this).text().replace(userLookupField + '_', '');
                            });
                        });
                    }
                }
            });
                        
            //$( "div.task_input_short select[name$='_mlktp']" ).css('display','none').parent().parent().removeClass('requiredInput').css('display','inline-block').find('.requiredBlock').remove();
            $( "div.task_input_short select[name$='_mlktp']" ).css('display','none').parent().parent().css('display','inline-block');
            var $select = $( "div.user_column select[name$='userType_mlktp']" );
            $select.change(function() {
                var a = $(this).val();
                var $dv = $(this).parent().find('.task_input_short');
                var $sel = $dv.find("select[name$='_mlktp']");
                var $inp = $dv.find("input[name$='_lktp']");
                if (a == 'SourceUserFields') {
                    $dv.css('display','none');
                    $sel.val( '' );
                    $inp.val( '' );
                    //$sel.change();
                    //$(this).parent().find('.task_input_short').css('display','none').find('select').val( '' ).change();
                    $(this).parent().parent().parent().find('.userLookupFields').css('display','inline-block');
                }
                else {
                    $dv.css('display','inline-block');
                    $sel.val( a );
                    $inp.val( a );
                    //$sel.change();
                    //$(this).parent().find('.task_input_short').css('display','inline-block').find('select').val( a ).change();
                    $(this).parent().parent().parent().find('.userLookupFields').css('display','none');
                }
                
                //console.log('...' + $( "div.task_input_short > span.lookupInput input" ).attr('id'));
                //LookupAutoCompleteInputElement.handleLookupTypeChange( $( "div.task_input_short > span.lookupInput input" ).attr('id') ,false);
            });
            $select.change();
        }
    </script>
        
	<apex:outputPanel layout="none" rendered="{!isLightning}">
		<apex:stylesheet value="{!URLFOR($Resource.advpm__SLDS0112, 'assets/styles/salesforce-lightning-design-system-vf.css')}" />
		<style type="text/css">
			.slds .slds-page-header {padding-left: 10px;}
			.slds .slds-table tr > th:first-child, .slds .slds-table tr > td:first-child {padding-left: 8px;}
			.detailPage .bPageBlock, .editPage .bPageBlock {border-top-width: 0px;}
			body .pbBody table.list tr.headerRow td, body .pbBody table.list tr.headerRow th {border-width: 0 0 1px 1px;}
			body .pbBody table.list tr.headerRow td, body .pbBody table.list tr.headerRow th {background: #ffffff;border-width: 0 0 1px 1px;padding: 8px;}
			body .bRelatedList .pbBody table.list, body .apexp .pbBody table.list {border-left-width: 0px!important;border-right-width: 0px!important;}
			body .pbBody table.list tr.headerRow th:first-child {border-left-width: 0px!important;}
			body .bRelatedList .pbBody table.list, body .apexp .pbBody table.list {border-top-width: 0px;}
			.slds tr.headerRow th, .slds tr.headerRow th.headerRow {font-weight: normal!important;}
			.weekend-table td:first-child{width:20px;}
		</style>
		<script type="text/javascript">
			/* This method is invoked when clicking over a button*/
			function disableActions() {
			   return true;
			}
			function enableActions() {
			   return true;
			}
		</script>
	</apex:outputPanel>
	
    <apex:outputPanel layout="block" rendered="{!!hasRelated}">
    </apex:outputPanel>
    <apex:outputPanel layout="block" id="emptyBlock" />
    <apex:sectionHeader title="{!$Label.advpm__ap_action_plan} {!$Label.advpm__ap_edit}" subtitle="{!IF(actionPlan.Id != null,actionPlan.Name,$Label.advpm__ap_newactionplan)}" help="{!URLFOR($Page.advpm__HelpActionPlan)}" rendered="{!!isLightning}" />
    <apex:outputPanel layout="block" styleClass="slds" rendered="{!isLightning}">
		<div class="slds-page-header" role="banner">
			<nav class="slds-m-bottom--xx-small" role="navigation">
				<ol class="slds-breadcrumb slds-list--horizontal" aria-labelledby="bread-crumb-label">
			      	<li class="slds-list__item slds-text-heading--label"><apex:outputLink value="/{!$ObjectType.advpm__ActionPlan__c.keyPrefix}">{!$ObjectType.advpm__ActionPlan__c.label}</apex:outputLink></li>
			   	</ol>
			</nav>
			<div class="slds-grid">
		    	<div class="slds-col slds-has-flexi-truncate">
		      		<h1 class="slds-text-heading--medium slds-truncate" title="{!IF(actionPlan.Id != null,actionPlan.Name,$Label.advpm__ap_newactionplan)}">{!IF(actionPlan.Id != null,actionPlan.Name,$Label.advpm__ap_newactionplan)}</h1>
		    	</div>
	    	</div>
		</div>
	</apex:outputPanel>
    
    <apex:outputPanel id="opContainer">
    <apex:form id="apForm" styleClass="{!IF(isLightning,'slds','')}">
        <apex:actionFunction name="doRedirect" action="{!cancel}" immediate="true" />
        <apex:actionFunction name="doSave" action="{!save}" rerender="opContainer" oncomplete="initAssignedToLookups();if ({!saveSuccess}){setTimeout('ActionPlanCreationScripts.showSaveSuccessSimpleDialog();', 200);}" /><!-- setTimeout('ActionPlanCreationScripts.showSaveSuccessSimpleDialog();', 200); -->
        <apex:actionFunction name="doSaveFromAPEdit" action="{!save}" rerender="opContainer" oncomplete="initAssignedToLookups();if ({!saveSuccess}){setTimeout('doRedirect();', 200);}" />
        
        <apex:actionFunction name="refreshRelatedObjectsLookUp" 
                            action="{!refreshRelatedObjectsLookUp}" 
                            immediate="true"
                            status="lookStatus"
                            rerender="lookupSectionOutPanel"
                            oncomplete="javascript:enableActions();">
            <apex:param name="relatedObjectSelected" value="" />
        </apex:actionFunction>
        
        <!-- Needed for rendering form -->
        <apex:outputField value="{!advpm__ActionPlan__c.Name}" rendered="false" />
        <apex:outputField value="{!advpm__ActionPlan__c.advpm__Action_Plan_Template__c}" rendered="false" /> 
        <apex:outputField value="{!advpm__ActionPlan__c.advpm__StartDate__c}" rendered="false" />
        <apex:outputPanel rendered="true" style="display:none">
            <apex:inputField value="{!advpm__ActionPlan__c.advpm__SkipDay__c}" />
            <apex:inputField value="{!advpm__ActionPlan__c.advpm__SkipWeekends__c}" />
        </apex:outputPanel>
        <apex:outputField value="{!advpm__ActionPlan__c.advpm__Account__c}" rendered="false" />
        <apex:outputField value="{!advpm__ActionPlan__c.advpm__Contact__c}" rendered="false" />
        <apex:outputField value="{!advpm__ActionPlan__c.advpm__Matter__c}" rendered="false" />
        
        
        <apex:outputPanel rendered="{!(actionPlan.Id != null)}">
            <apex:inputHidden value="{!actionPlan.Id}" id="Id" />
        </apex:outputPanel>
        <input type="hidden" class="hidden_refID" value="{!RefId}"></input>
        <input type="hidden" class="hidden_refOBjtype" value="{!refType}"></input>
        
        <apex:pageBlock id="editBlock" title="{!IF(isLightning,'','Action Plan Edit')}" mode="edit">
            <apex:pageMessages id="msgs" ></apex:pageMessages>
            
            <apex:pageBlockButtons id="buttons">
                <apex:commandButton styleClass="slds-button slds-button--neutral" id="save" value="{!$Label.advpm__ap_save}" rerender="emptyBlock" onclick="if('{!JSINHTMLENCODE($CurrentPage.parameters.sl)}'=='1') {doSaveFromAPEdit();} else {doSave();} setTimeout('disableActions();', 50);" rendered="{!APTemplateExists}"/>
                <apex:commandButton styleClass="slds-button slds-button--neutral" id="cancel" immediate="true" action="{!cancel}" value="{!$Label.advpm__ap_cancel}" onclick="setTimeout('disableActions();', 50);"/>
            </apex:pageBlockButtons>
            <script type="text/javascript">
                disableActions();
                var apTaskSize = {!Tasks.size};
                var buttonsTimeout = setInterval("ActionPlanCreationScripts.enableButtonsOnComplete()", 500);
            </script>
            
            <!-- Information Section -->
            <apex:pageBlockSection id="informationSection" title="{!$Label.advpm__ap_information}" columns="{!IF(DisplayTemplateLookup, '2', '1')}">
                
                <apex:pageBlockSectionItem id="nameSectionItem">
                    <apex:outputLabel value="{!$Label.advpm__ap_action_plan} {!$Label.advpm__ap_name}" for="Name"/>
                    <apex:inputField value="{!actionPlan.Name}" id="Name" required="true" /> 
                </apex:pageBlockSectionItem>
                
                <apex:pageBlockSectionItem rendered="{!IF(DisplayTemplateLookup, true, false)}">
                    <apex:outputLabel value="{!$Label.advpm__ap_action_plan_template}" for="templateLookup"/>
                    <apex:inputField id="templateLookup" 
                                     required="true" 
                                     styleClass="{!IF(throwError !=null,'errorBorder','')}" 
                                     value="{!actionPlan.advpm__Action_Plan_Template__c}"  
                                     onchange="javascript:ActionPlanCreationScripts.reloadActionPlan('{!JSINHTMLENCODE(TemplateId)}', document.getElementById('{!$Component.templateLookup}_lkid').value);"
                                     onkeydown="javascript:ActionPlanCreationScripts.clearAPName(event)">
                        <script type="text/javascript">
                            var templateLKP_path = "{!$Component.templateLookup}";
                            var fieldId = templateLKP_path+'_lkid';
                            if (document.getElementById(fieldId) != null && document.getElementById(fieldId).type=="hidden"){
                                var selectedTmplId = document.getElementById(fieldId).value;
                                ActionPlanCreationScripts.reloadActionPlan("{!JSENCODE(TemplateId)}", selectedTmplId);
                            }else{
                                if (document.getElementById(fieldId).type == "select-one"){
                                    document.getElementById(fieldId).selectedIndex =0;
                                }
                            }
                            
                        </script>
                    </apex:inputField>
                </apex:pageBlockSectionItem>
                
                <apex:pageBlockSectionItem id="StartDateReadonlySection" rendered="{!StartDateReadonly}">
                    <apex:outputLabel value="{!$Label.advpm__ap_planstartdate}"/>
                    <apex:outputField id="StartDateReadonly" value="{!actionPlan.advpm__StartDate__c}"/>
                </apex:pageBlockSectionItem>
                
                <apex:pageBlockSectionItem id="StartDateSection" rendered="{!!StartDateReadonly}">
                    <apex:outputLabel value="{!$Label.advpm__ap_planstartdate}" for="StartDate"/>
                    <apex:outputText >
                        <apex:inputField id="StartDate" required="true" value="{!actionPlan.advpm__StartDate__c}" onclick="ActionPlanCreationScripts.showAgain();" onchange="ActionPlanCreationScripts.refreshItemDates();" />
                        <apex:outputText rendered="{!relatedObjNameList.size > 1}"><span style="color:#cc0000"><strong>NOTE:</strong> Since multiple {!relatedObjName} have been selected, Start Date has been defaulted to Today's date, instead of Template selected default field.</span></apex:outputText>
                    </apex:outputText>
                </apex:pageBlockSectionItem> 
                
                <apex:pageBlockSectionItem />
                
                <apex:pageBlockSectionItem rendered="{!hasRelated}">
                    <apex:outputLabel value="{!$Label.advpm__ap_related_to}" />
                    <apex:outputPanel id="RelatedSection" >
                        <apex:dataList value="{!relatedObjNameList}" var="objName" rendered="{!relatedObjNameList.size > 1}" style="padding:0px;margin:0px;">
                            <apex:outputText value="{!objName}"/>
                        </apex:dataList>
                        <apex:repeat value="{!relatedObjNameList}" var="objName" rendered="{!relatedObjNameList.size == 1}">
                            <apex:outputText value="{!objName}"/>
                        </apex:repeat>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
                
                <apex:pageBlockSectionItem rendered="{!!hasRelated}">
                    <apex:outputText rendered="{!!hasRelatedObject}">
                        <apex:selectList id="typeLookup" 
                                value="{!relatedObjectSelected}"
                                multiselect="false"
                                size="1"
                                onchange="disableActions();refreshRelatedObjectsLookUp(this.value);"><!-- disabled="{!JSINHTMLENCODE(templateId) != null && JSINHTMLENCODE(templateId) != ''}" -->
                                
                            <apex:selectOptions value="{!relatedObjectOptions}"/>
                        </apex:selectList>                        
                    </apex:outputText>
                 
                    <apex:actionStatus id="lookStatus" >
                        <apex:facet name="start">
                            <apex:outputText >(loading...)</apex:outputText>
                        </apex:facet>
                        <apex:facet name="stop">
                             <apex:outputPanel layout="block" rendered="{!!hasRelatedObject}">
        
                                <apex:outputPanel id="lookupSectionOutPanel" layout="block">
                                     <apex:outputPanel id="aLookup" rendered="{!relatedObjectSelected == 'Account'}" > 
                                         <apex:pageBlockSectionItem id="aLookupSection">
                                            <apex:inputField id="aName" required="true" value="{!actionPlan.advpm__Account__c}" styleClass="{!IF(throwError !=null,'errorBorder','')}" />
                                         </apex:pageBlockSectionItem>
                                     </apex:outputPanel>
                                     
                                     <apex:outputPanel id="cLookup" rendered="{!relatedObjectSelected == 'Contact'}">
                                         <apex:pageBlockSectionItem id="cLookupSection">
                                            <apex:inputField id="cName" required="true" styleClass="{!IF(throwError !=null,'errorBorder','')}" value="{!actionPlan.advpm__Contact__c}" />
                                         </apex:pageBlockSectionItem>
                                     </apex:outputPanel>
                                     
                                     <apex:outputPanel id="oLookup" rendered="{!relatedObjectSelected == 'advpm__Matter__c'}">
                                         <apex:pageBlockSectionItem id="oLookupSection">
                                            <apex:inputField id="oName" required="true" styleClass="{!IF(throwError !=null,'errorBorder','')}" value="{!actionPlan.advpm__Matter__c}" />
                                         </apex:pageBlockSectionItem>
                                     </apex:outputPanel>
                                     
                                     <apex:outputPanel id="errorDivLookUp" layout="block" styleclass="errorMsg" rendered="{!IF(throwError !=null,true,false)}" >
                                        <b>{!$Label.advpm__ap_error}:</b> {!throwError}
                                     </apex:outputPanel>
                                </apex:outputPanel>                                    
                            </apex:outputPanel>
                        </apex:facet>
                      </apex:actionStatus>
                </apex:pageBlockSectionItem>
                
            </apex:pageBlockSection>
            <!-- End Information Section -->
            
            <!--  Start Related Section -->
            <!-- <apex:pageBlockSection id="LookupSection" title="{!$Label.ap_RelatedObject}" columns="2" rendered="{!!hasRelated}">
                <apex:outputText id="relatedToOutput" rendered="{!hasRelatedObject}">
                     <apex:outputField value="{!actionPlan.advpm__Account__c}"     rendered="{!(actionPlan.Account__c != null)}" />
                     <apex:outputField value="{!actionPlan.advpm__Contact__c}"     rendered="{!(actionPlan.Contact__c != null)}" />
                     <apex:outputField value="{!actionPlan.advpm__Matter__c}"      rendered="{!(actionPlan.Matter__c != null)}" />
                </apex:outputText>
            </apex:pageBlockSection> -->
            <!--  End Related Section -->
            
            <!-- Tasks Section -->
            <apex:pageBlockSection id="taskSection" title="{!$Label.advpm__ap_tasks}" columns="1"> 

                <apex:panelGrid columns="2" styleClass="weekend-table">
                    <apex:outputText ><apex:inputCheckbox value="{!ActionPlan.advpm__SkipWeekends__c}" id="skipWeekendCheckbox" onclick="javascript:ActionPlanCreationScripts.checkSkipWeekend();ActionPlanCreationScripts.refreshItemDates();" style="margin:0px;{!IF(isLightning,'margin-top:3px;','')}"/></apex:outputText>
                    <apex:outputLabel for="skipWeekendCheckbox" value="{!$Label.advpm__ap_skipweekendswhen}"/>
                </apex:panelGrid>
                
                <apex:panelGrid columns="2" id="skipDayTable">
                    <apex:outputText >{!$Label.advpm__ap_defaultweekendduedates} </apex:outputText>
                    <apex:outputText >
                        <apex:pageBlockSectionItem id="skipDaySection"><apex:inputField id="skipDayPicklist" value="{!ActionPlan.advpm__SkipDay__c}" onchange="ActionPlanCreationScripts.refreshItemDates();" style="margin: -2px;" /></apex:pageBlockSectionItem>
                    </apex:outputText>
                </apex:panelGrid>
                
                <apex:outputPanel rendered="{!ActionPlan.advpm__Action_Plan_Template__c != null}">
                    <apex:inputHidden value="{!ActionPlan.advpm__Action_Plan_Template__c}" />
                </apex:outputPanel>
                
                <br />
                
                <apex:outputPanel id="taskList">
                    <div>
                        <div id="tasksListLoader" style="display:none">
                            <div id="tasksListLoaderMessage" style="text-align:center">(loading...)</div>
                        </div>
                        <div>
                            <apex:dataTable value="{!Tasks}" var="wrapTask" id="taskTable" columnClasses="first,actType,second,third,fourth,startTimeCol,durationCol,fifth,sixth,septh,eight,ninth,tenth" styleClass="taskTable" rowClasses="taskTableRow" >
                               <!--  Tasks delete actions  -->
                               <apex:column id="columnOne" headerValue="" headerClass="firstCol slds-text-heading--label" style="padding-left:3px;" >
                                     <apex:commandLink rerender="taskTable, taskStatus, informationSection, lookupSectionOutPanel, msg" 
                                                       immediate="{!wrapTask.isLast}"
                                                       action="{!removeTask}" 
                                                       rendered="{!Tasks.size > 1}" 
                                                       onclick="if (ActionPlanCreationScripts.confirmTaskDeletion_NEW('.dependent_{!CEILING(wrapTask.task.advpm__taskIndex__c)}')) return false;javascript:ActionPlanCreationScripts.showTasksListLoader();" 
                                                       oncomplete="showErrors(); ActionPlanCreationScripts.checkReminderPicklists(); ActionPlanCreationScripts.hideTasksListLoader(); initAssignedToLookups();"
                                                       style="top: 3px;position: relative;"> 
                                          <img src="{!$Resource.ActionPlans_cross}" alt="{!$Label.ap_Remove} "/>
                                          <apex:param name="remove" value="{!wrapTask.position}"/>
                                          <apex:param name="tindex" value="{!CEILING(wrapTask.task.advpm__taskIndex__c)}"/>
                                      </apex:commandLink>
                                </apex:column>
                                
                                <!--  Tasks activity_type  -->
                                <apex:column headerClass="actTypeN actTypeCol slds-text-heading--label" headerValue="{!$ObjectType.advpm__APTaskTemplate__c.fields.advpm__Activity_Type__c.label}">
                                    <apex:pageBlockSectionItem >
                                        <apex:inputField style="margin-left:0px;" id="activityType" required="true" value="{!wrapTask.task.advpm__Activity_Type__c}" onchange="javascript:ActionPlanCreationScripts.toggleEventFields(this.value,'{!$Component.taskTable.columnOne}');" styleClass="selectDepending" />
                                    </apex:pageBlockSectionItem>
                                </apex:column>
                                
                                <!--  Tasks subject  -->
                                <apex:column headerValue="{!$ObjectType.advpm__APTaskTemplate__c.fields.advpm__Subject__c.label}" headerClass="thirdN subjectCol slds-text-heading--label" >
                                    <apex:pageBlockSectionItem >
                                        <apex:inputField style="margin-left:0px;" required="true" value="{!wrapTask.task.advpm__Subject__c}" styleClass="task_input_short" />
                                    </apex:pageBlockSectionItem>
                                </apex:column>

                                <!--  Tasks depending status  -->                               
                                <apex:column rendered="{!IF(TaskSize > 1, true, false)}" headerValue="{!$ObjectType.advpm__APTaskTemplate__c.fields.advpm__APTaskTemplate__c.label}" headerClass="thirdN dependencyColumn slds-text-heading--label" >
                                    <apex:selectList id="dependent" value="{!wrapTask.task.advpm__Dependent__c}" multiselect="false" size="1" style="max-width:140px;min-width:100px;" 
                                            onchange="javascript:ActionPlanCreationScripts.checkDependent_NEW('.dependent_{!CEILING(wrapTask.task.advpm__taskIndex__c)}');ActionPlanCreationScripts.refreshItemDates();" 
                                            styleClass="selectDepending dependent_{!CEILING(wrapTask.task.advpm__taskIndex__c)}">
                                        <apex:selectOptions value="{!SubjectItems}" />
                                    </apex:selectList>
                                    <apex:inputHidden value="{!wrapTask.task.advpm__taskIndex__c}" id="theHiddenInput"/>
                                </apex:column>

                                <!--  Tasks Days After  -->                             
                                <apex:column headerClass="fourthN daysCol slds-text-heading--label" >
                                    <apex:facet name="header">
                                        <div style="margin-right:8px;">Days Before<br/>or After<!-- <img class="helpOrb" title="{!$Label.ap_days_after_msg}" src="/s.gif"/> --></div>
                                    </apex:facet>
                                    
                                    <div style="float:left;width:50%;">
                                        <apex:inputField style="margin-left:0px;width:28px;" id="daysFromStart" onchange="javascript:ActionPlanCreationScripts.checkDays('{!$Component.taskTable.columnOne}');ActionPlanCreationScripts.refreshItemDates();" value="{!wrapTask.task.advpm__DaysFromStart__c}" styleClass="days_input" />
                                    </div>
                                    <div style="float:left;margin-top:4px">
                                        <apex:image id="calendarDueDate" 
                                            onmouseover="javascript:ActionPlanCreationScripts.showCalendar('{!$Component.taskTable.columnOne}');" 
                                            onmouseout="javascript:ActionPlanCreationScripts.hideCalendar();" 
                                            styleClass="datePickerIcon"
                                            value="/s.gif"
                                            style="float:left">
                                        </apex:image>
                                    </div>
                                    <div style="display:none"><apex:inputField id="activityDate" value="{!wrapTask.task.advpm__ActivityDate__c}" /></div>                   
                                </apex:column>
                                
                                <!--  Tasks start_time  --> 
                                <apex:column headerClass="startTimeN startTimeCol slds-text-heading--label">
                                    <apex:facet name="header"><div style="margin-right:8px;">Start<br/>Time</div></apex:facet>
                                    <apex:outputPanel id="startTimePanel" style="display:{!IF(wrapTask.task.advpm__Activity_Type__c=='Event','block','none')}">
                                    
                                        <apex:selectList id="startTimePickList" size="1" value="{!wrapTask.task.advpm__Start_Time__c}" style="float:left;width:87px;">
                                            <apex:selectOptions value="{!actionPlans.hoursOption}" />
                                        </apex:selectList>
                                        
                                    </apex:outputPanel>
                                </apex:column>
                                
                                <!--  Tasks duration  -->   
                                <apex:column headerClass="durationN durationCol slds-text-heading--label">
                                    <apex:facet name="header"><div style="margin-right:8px;">Duration<br/>(in minutes)</div></apex:facet>
                                    <apex:outputPanel id="durationPanel" style="display:{!IF(wrapTask.task.advpm__Activity_Type__c=='Event','block','none')}">
                                    
                                        <apex:inputField id="duration" required="false" value="{!wrapTask.task.advpm__DurationInMinutes__c}" style="width:40px" />
                                        
                                    </apex:outputPanel>
                                </apex:column>
                           
                                <!--  Tasks Assigned TO  -->                                    
                                <apex:column headerValue="{!$ObjectType.advpm__APTaskTemplate__c.fields.advpm__User__c.label}"  headerClass="fifthN assigned_to_field slds-text-heading--label" >
                                    <div class="user_column" style="">
                                        <apex:outputPanel id="ownerRecordPanel" styleClass="user_column_child" layout="block" style="float: left;">
                                            <apex:outputPanel layout="block" rendered="{!wrapTask.displayLookUp}" styleClass="requiredInput" style="white-space: nowrap;">
                                                <div class="requiredBlock"></div>
                                                <apex:selectList id="userType_mlktp" value="{!wrapTask.task.advpm__User_Type__c}" size="1" multiselect="false" title="Assigned To Scope" style="vertical-align: top;margin-left:0px;">
                                                    <apex:selectOption itemValue="005" itemLabel="Specified User"  />
                                                    <apex:selectOption itemValue="CustomerSuccessUserLookup" itemLabel="Portal User" />
                                                    <apex:selectOption itemValue="SourceUserFields" itemLabel="All User Fields" />
                                                </apex:selectList>
                                                <apex:inputField required="false" value="{!wrapTask.task.advpm__User__c}"  styleClass="task_input_short" />
                                            </apex:outputPanel>
                                            <apex:pageBlockSectionItem rendered="{!!wrapTask.displayLookUp}">
                                                <apex:outputPanel layout="none">[<strong>{!wrapTask.sourceUserField}</strong>]
                                                    <apex:inputHidden value="{!wrapTask.task.advpm__User_Type__c}" />
                                                    <apex:inputHidden value="{!wrapTask.task.advpm__User_Source_Field__c}" />
                                                </apex:outputPanel>
                                            </apex:pageBlockSectionItem> 
                                        </apex:outputPanel>
                                        <apex:outputPanel styleClass="user_column_child" layout="block" rendered="{!wrapTask.displayLookUp}">
                                            <div class="userLookupFields">
                                                <apex:selectList id="userLookupFields" size="1" value="{!wrapTask.task.advpm__User_Source_Field__c}" title="User Lookup Fields">
                                                    <apex:selectOptions value="{!relatedObjUserLookups}" />
                                                </apex:selectList>
                                            </div>
                                        </apex:outputPanel>
                                    </div>
                                </apex:column> 
                                
                                <!--  Tasks type  -->                                   
                                <apex:column headerValue="{!$ObjectType.advpm__APTaskTemplate__c.fields.advpm__Type__c.label}"  headerClass="sixthN typeCol slds-text-heading--label">
                                    <apex:outputPanel id="categoryPanel">
                                        <apex:inputField required="false" value="{!wrapTask.task.advpm__Type__c}" style="width:90px" />
                                    </apex:outputPanel>
                                </apex:column>
                                
                                <!--  Tasks priority  -->   
                                <apex:column headerValue="{!$ObjectType.advpm__APTaskTemplate__c.fields.advpm__Priority__c.label}"  headerClass="septhN priorityCol slds-text-heading--label">
                                    <apex:outputPanel id="priorityPanel" style="white-space: nowrap;display:{!IF(wrapTask.task.advpm__Activity_Type__c=='Task','block','none')}" layout="block" styleClass="requiredInput">
                                        <div class="requiredBlock"></div>
                                        <apex:inputField required="false" value="{!wrapTask.task.advpm__Priority__c}" style="margin-left:0px;" />
                                    </apex:outputPanel>
                                </apex:column>
                                
                                <!--  Tasks send Email  -->                                
                                <apex:column headerClass="eigthN sendMailCol slds-text-heading--label">
                                    <apex:facet name="header">
                                        {!$ObjectType.APTaskTemplate__c.fields.SendEmail__c.label} <br/>
                                        <a id="all" onclick="javascript:ActionPlanCreationScripts.checkEmail(1);" class="all-none">{!$Label.ap_All}</a> | 
                                        <a id="none" onclick="javascript:ActionPlanCreationScripts.checkEmail(0);" class="all-none">{!$Label.ap_None}</a>
                                    </apex:facet>
                                    <apex:outputPanel id="emailSection" style="display:{!IF(wrapTask.task.advpm__Activity_Type__c=='Task','block','none')}">
                                        <apex:inputField id="email" value="{!wrapTask.task.advpm__SendEmail__c}" style="margin-top: 4px;margin-left: 0px;" />
                                    </apex:outputPanel>
                                </apex:column>
                                
                                <!--  Tasks reminder settings  -->  
                                <apex:column rendered="{!displayReminder}"  headerClass="ninthN reminderCol slds-text-heading--label">
                                    <apex:facet name="header">{!$ObjectType.APTaskTemplate__c.fields.Reminder__c.label} <br/>
                                    <a id="reminderAll" onclick="javascript:ActionPlanCreationScripts.checkReminder(1);" class="all-none">{!$Label.ap_All}</a> | 
                                    <a id="reminderNone" onclick="javascript:ActionPlanCreationScripts.checkReminder(0);" class="all-none">{!$Label.ap_None}</a></apex:facet>
                                    <div style="width:110px;">
                                    <apex:pageBlockSectionItem id="reminderSection">
                                    
                                        <apex:inputField id="reminder" value="{!wrapTask.task.advpm__Reminder__c}" style="margin-top: 4px;margin-left: 0px;" onclick="javascript:ActionPlanCreationScripts.enableDisableReminderPicklist('{!$Component.taskTable.columnOne}');" />
                                        <apex:selectList id="reminderPickList" size="1" value="{!wrapTask.task.advpm__Minutes_Reminder__c}" style="">
                                            <apex:selectOptions value="{!actionPlans.hoursOption}" />
                                        </apex:selectList>
                                        
                                    </apex:pageBlockSectionItem>
                                    </div>
                                </apex:column>
                                
                                <!--  Tasks comments  -->                                  
                                <apex:column headerValue="{!$ObjectType.advpm__APTaskTemplate__c.fields.advpm__Comments__c.label}"  headerClass="tenthN commentsCol slds-text-heading--label">
                                    <apex:outputPanel id="commentPanel" style="display:none">
                                        <div id="commentContainer">
                                            <div class="hd">
                                                <div class="hd-left">{!$Label.ap_Comments}</div>
                                                <div class="hd-right"><input class="btn {!IF(isLightning,'slds-button slds-button--neutral','')}" style="margin-bottom:1px;{!IF(isLightning,'padding-left:10px;padding-right:10px;line-height:18px;','')}" type="button" onclick="javascript:ActionPlanCreationScripts.hideComments('{!$Component.taskTable.columnOne}');" title="{!$Label.ap_Close}" name="closeCommentPanel" value=" {!$Label.ap_Close} "/></div>
                                            </div>
                                            <div class="bd">
                                                <apex:inputField id="Comments" value="{!wrapTask.task.advpm__Comments__c}" onchange="document.getElementById('{!$Component.taskTable.columnOne}:commentLink').innerHTML= '...'" />
                                            </div>
                                        </div>
                                    </apex:outputPanel>
                                    (<a id="{!$Component.taskTable.columnOne}:commentLink" onclick="javascript:ActionPlanCreationScripts.showComments('{!$Component.taskTable.columnOne}');" style="text-decoration:underline"><apex:outputText rendered="{!wrapTask.task.advpm__Comments__c != null}">...</apex:outputText><apex:outputText rendered="{!wrapTask.task.advpm__Comments__c == null}">{!LOWER($Label.advpm__ap_add)}</apex:outputText></a>)
                                </apex:column>
                            </apex:dataTable>
                        </div>
                    </div>
                    <br/>
                </apex:outputPanel>
                
                <apex:panelGrid columns="2">
                    <apex:outputText >
                        <apex:commandLink action="{!addTask}" style="font-weight:bold" rerender="taskList, taskStatus, informationSection, lookupSectionOutPanel, msgs" 
                                status="taskTableStatus" 
                                onclick="disableActions();ActionPlanCreationScripts.showTasksListLoader();" 
                                oncomplete="enableActions();showErrors();ActionPlanCreationScripts.displayTaskAssigneeStatus();ActionPlanCreationScripts.checkAllDependent_NEW();ActionPlanCreationScripts.checkReminderPicklists();ActionPlanCreationScripts.hideTasksListLoader();initAssignedToLookups();" >
                            {!$Label.advpm__ap_addnewtask}
                            <apex:param name="add" value="1"/>
                        </apex:commandLink>
                    </apex:outputText>
                    <apex:outputText style="color:#cc0000 !important;">&nbsp;
                        <apex:actionStatus id="taskStatus">
                            <apex:facet name="start">
                                <apex:outputText value="(loading...)"/>
                            </apex:facet>
                            <apex:facet name="stop">
                                <apex:outputText value="{!$Label.advpm__ap_error}: {!ErrorMsg}" styleClass="errorMessage" rendered="{!(ErrorMsg != null)}"/>
                            </apex:facet>
                        </apex:actionStatus>
                    </apex:outputText>
                </apex:panelGrid>
            </apex:pageBlockSection>
            <!-- End Tasks Section -->
            
            <div id="error" style="text-align:center">
                <span class="pbError">{!$Label.advpm__ap_errors_review_errors}</span>
            </div>
        </apex:pageBlock>
        
    </apex:form>
    <script>
        ActionPlanCreationScripts.checkSkipWeekend();
        ActionPlanCreationScripts.checkReminderPicklists();
        ActionPlanCreationScripts.checkAllDependent_NEW();

        showErrors();
    </script>
    </apex:outputPanel>
</apex:outputPanel>
</apex:page>