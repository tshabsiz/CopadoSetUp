<apex:page controller="Case_Checklist_Form_Controller" sidebar="false" showHeader="false" standardStylesheets="false">
    <head>
        <apex:stylesheet value="{!URLFOR($Resource.LDS2, 'assets/styles/salesforce-lightning-design-system.min.css')}" />
        <apex:includeScript value="/support/console/39.0/integration.js" />
        <script src="../../soap/ajax/39.0/connection.js" type="text/javascript" >
        </script>
        <script src="../../soap/ajax/39.0/apex.js" type="text/javascript" >
        </script>
    </head>
    <apex:form id="chkForm">
        <apex:pageMessages ></apex:pageMessages>
         <div style="right:0;position:fixed;z-index:99;" id="btndiv">
            <button  type="button" id="btn" onclick="updateMetaData();" >
                Save Selection
            </button>
        </div>
        <table class="slds-table slds-table_bordered" width="100%">
            <apex:repeat value="{!wFormStructure}" var="head">
                <thead>
                    <tr class="slds-text-title_caps">
                        <th scope="col" width="80%">
                            <div style="font-weight: bold;font-size: large;" title="Heading">{!head.heading}</div>
                        </th>
                        <th scope="col" width="10%">
                            <div class="slds-truncate" title=""></div>
                        </th>
                        <th scope="col" width="10%">
                            <div class="slds-truncate" title=""></div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <apex:repeat value="{!head.questions}" var="val">
                        <tr>
                            <td data-label="question" >
                                <div  title="question">{!val.question}</div>
                            </td>
                            <td data-label="selection" >
                                <fieldset class="slds-form-element" id="{!val.question}">
                                    <div class="slds-form-element__control">
                                        <div class="slds-radio_button-group">
                                            <span class="slds-button slds-radio_button">
                                                <input type="radio" name="{!val.question}" id="yes" value="Yes" title="{!val.isCheckedYes}" placeholder="{!val.questionId}"/>
                                                <label class="slds-radio_button__label" for="yes">
                                                    <span class="slds-radio_faux">Yes</span>
                                                </label>
                                            </span>
                                            <span class="slds-button slds-radio_button">
                                                <input type="radio" name="{!val.question}" id="no" value="No" title="{!val.isCheckedNo}" placeholder="{!val.questionId}" />
                                                <label class="slds-radio_button__label" for="no">
                                                    <span class="slds-radio_faux">No</span>
                                                </label>
                                            </span>
                                            <span class="slds-button slds-radio_button">
                                                <input type="radio" name="{!val.question}" id="na" value="NA" title="{!val.isCheckedNA}" placeholder="{!val.questionId}" />
                                                <label class="slds-radio_button__label" for="na">
                                                    <span class="slds-radio_faux">N/A</span>
                                                </label>
                                            </span>
                                            <br/>
                                            <apex:outputPanel rendered="{!showDate}">
                                                <input type="date" name="dates"  placeholder="{!val.questionId}" value="{!val.actionDate}"/>
                                            </apex:outputPanel>
                                                
                                        </div>
                                    </div>
                                </fieldset>
                            </td>
                        </tr>
                    </apex:repeat>
                </tbody>
            </apex:repeat>
        </table>
          <input value="{!chkListId}" id="chkid" type="hidden"/>
           <input type="hidden" id="readonly" value="{!makeReadOnly}"/>
           <!--
           <input value="{!templateId}" id="temp" />
           <input value="{!caseId}" id="caseId" />
           -->
    </apex:form>
    <script type="text/javascript">
    
    //check all radio buttons previously saved and disable if readonly param were detected
    var radios = document.getElementsByTagName('input');   
    for(var i=0; radios[i]; ++i){
        if(radios[i].title == 'checked'){
           radios[i].checked = true;
        }
        if(document.getElementById('readonly').value == 'true'){
            radios[i].disabled = true;
        }    
    }
    
    sforce.connection.sessionId = '{!$Api.Session_ID}';
    
    var saveButton = document.getElementById('btn');
    saveButton.style.background = '#0070d2';
    saveButton.style.borderColor = '#0070d2';
    saveButton.style.font = '13.3333px Arial';
    saveButton.style.color = 'white';
    saveButton.style.borderRadius = '4px';
    saveButton.style.padding = '10px 10px 10px 10px';
    saveButton.style.cursor = 'pointer';
    saveButton.disabled = false;
    //var btnDiv = document.getElementById('btndiv');
    //btnDiv.style.cursor = 'pointer';
    
    var metaData = '';

    function updateMetaData(){
        
        var caseId = '{!caseId}';
        var templateId = '{!templateId}';
        
        saveButton.disabled = true;
        document.getElementById('{!$Component.chkForm}').style.cursor = 'wait';
        
        var chkList = new sforce.SObject("Case_Checklist__c");

        if(document.getElementById('chkid').value != ''){
          chkList.Id = document.getElementById('chkid').value;             
        }
        
        var radios = document.getElementsByTagName('input');
        
        var dates  ;
        var foundDate;
        var dict = {};
        
        if('{!showDate}' =='true')
        {
            dates  = document.getElementsByName('dates');
            for(var x=0; dates[x]; ++x){
            dict[[dates[x].placeholder]] = dates[x].value;
        }
        }
        
        
        
        for(var i=0; radios[i]; ++i){
            
            
            if(radios[i].checked){
               
                console.log(dict[radios[i].placeholder]);
                //alert(dict[radios[i].placeholder]);
                
                if('{!showDate}' =='true')
                {
                    metaData += radios[i].placeholder + '|' + radios[i].value +'|' +  dict[radios[i].placeholder] +';';
                }
                else
                {
                    metaData += radios[i].placeholder + '|' + radios[i].value +';';
                }
                
                
            }
        }

        chkList.SavedResults__c = metaData;
        chkList.SubmittedBy__c = '{!$User.Id}';
        chkList.RelatedCase__c = caseId;
        chkList.ChecklistTemplate__c  = templateId;
        /**
        var currentdate = new Date(); 
        var datetime =   currentdate.getFullYear() + "-"
                     + (currentdate.getMonth()+1)  + "-" 
                     + currentdate.getDate() + " "  
                     + currentdate.getHours() + ":"  
                     + currentdate.getMinutes() + ":"
                     + currentdate.getSeconds();
        chkList.DateSubmitted__c = datetime;**/
       
        var result = sforce.connection.upsert("Id", [chkList]);
        
        if (result[0].getBoolean("success")){
            sforce.console.getFocusedPrimaryTabId(closetab);
        } else {
            alert("Failed to save this checklist: " + result[0]);
        }
    };
    
    var closetab = function closetab(result) {
            //Now that we have the tab ID, we can close it
            var tabId = result.id;
            sforce.console.closeTab(tabId);
    };
    
    </script>
</apex:page>