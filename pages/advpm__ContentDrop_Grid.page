<apex:page showHeader="false" sidebar="false" standardStyleSheets="false" controller="advpm.ContentDrop_Grid" applyBodyTag="false" applyHtmlTag="false" showChat="false"><html>
<head>
	<style type="text/css">
		body { font-size: 12px !important; }
	</style>

	<!-- <apex:includeScript value="{!URLFOR($Resource.jQueryZip, 'js/jquery-1.10.2.min.js')}" /> -->
	<apex:includeScript value="{!URLFOR($Resource.advpm__jQueryZip, 'js/jquery-1.11.1.min.js')}" />
	<apex:includeScript value="{!URLFOR($Resource.advpm__jQuery_Migrate, 'js/jquery-migrate-1.2.1.min.js')}" />
	
	<!-- Bootstrap styles -->
	<apex:stylesheet value="{!URLFOR($Resource.advpm__MBView_Bootstrap, 'bootstrap-3.1.1/css/bootstrap.min.css')}" />
	<apex:stylesheet value="{!URLFOR($Resource.advpm__jQuery_DataTables, 'DataTables-1.9.4/media/css/dataTables.bootstrap3.css')}" />
	
	<apex:includeScript value="{!URLFOR($Resource.advpm__jQuery_DataTables, 'DataTables-1.9.4/media/js/jquery.dataTables.min.js')}" />
	<apex:includeScript value="{!URLFOR($Resource.advpm__jQuery_DataTables, 'DataTables-1.9.4/media/js/ColReorderWithResize.js')}" />
	<apex:includeScript value="{!URLFOR($Resource.advpm__jQuery_DataTables, 'DataTables-1.9.4/media/js/dataTables.bootstrap3.js')}" />
	
	<apex:stylesheet value="{!URLFOR($Resource.advpm__jQuery_BubblePopup, 'Install/jquery-bubble-popup-v3.css')}" />
    <apex:includeScript value="{!URLFOR($Resource.advpm__jQuery_BubblePopup, 'Install/jquery-bubble-popup-v3.FIXED.js')}" />
    
	<style type="text/css">
		.sorting { background-image: url("{!URLFOR($Resource.advpm__jQuery_DataTables, 'DataTables-1.9.4/media/images/sort_both.png')}") !important; background-repeat:no-repeat !important; background-position:center right !important; }
		.sorting_asc { background-image: url("{!URLFOR($Resource.advpm__jQuery_DataTables, 'DataTables-1.9.4/media/images/sort_asc.png')}") !important; background-repeat:no-repeat !important; background-position:center right !important; }
		.sorting_desc { background-image: url("{!URLFOR($Resource.advpm__jQuery_DataTables, 'DataTables-1.9.4/media/images/sort_desc.png')}") !important; background-repeat:no-repeat !important; background-position:center right !important; }
		.sorting_asc_disabled { background: url("{!URLFOR($Resource.advpm__jQuery_DataTables, 'DataTables-1.9.4/media/images/sort_asc_disabled.png')}") !important; background-repeat:no-repeat !important; background-position:center right !important; }
		.sorting_desc_disabled { background: url("{!URLFOR($Resource.advpm__jQuery_DataTables, 'DataTables-1.9.4/media/images/sort_desc_disabled.png')}") !important; background-repeat:no-repeat !important; background-position:center right !important; }
		/*.col1 { max-width: 80px; }
		.col2 { max-width: 150px; }
		.col3 { max-width: 60px; }
		.col4 { max-width: 60px; }
		.col5 { max-width: 100px; }
		.col6 { max-width: 60px; }
		.col7 { max-width: 105px; }
		.col8 { max-width: 105px; }
		.col9 { max-width: 80px; }*/
		.ellipsis { white-space: nowrap;overflow: hidden;text-overflow: ellipsis;-o-text-overflow: ellipsis; }
		.progress { margin-bottom: 0px !important; }
	</style>
	
	<!-- CSS to style the file input field as button and adjust the Bootstrap progress bars -->
	<apex:stylesheet value="{!URLFOR($Resource.advpm__jQuery_FileUpload, 'jQuery-File-Upload-9.5.7/css/jquery.fileupload.css')}" />
	<apex:stylesheet value="{!URLFOR($Resource.advpm__jQuery_FileUpload, 'jQuery-File-Upload-9.5.7/css/jquery.fileupload-ui.css')}" />
	<!-- CSS adjustments for browsers with JavaScript disabled -->
	<noscript><apex:stylesheet value="{!URLFOR($Resource.advpm__jQuery_FileUpload, 'jQuery-File-Upload-9.5.7/css/jquery.fileupload-noscript.css')}" /></noscript>
	<noscript><apex:stylesheet value="{!URLFOR($Resource.advpm__jQuery_FileUpload, 'jQuery-File-Upload-9.5.7/css/jquery.fileupload-ui-noscript.css')}" /></noscript>
	
	<style type="text/css">
		.tb-data-row.in {/*width: 600px;height: 200px;line-height: 200px;font-size: larger;*/}
		.tb-data-row.hover {background: #FFF380;}
		tr.tb-data-row:hover { background-color: #D2DEE8 !important; }
		.tb-data-row.fade {-webkit-transition: all 0.3s ease-out;-moz-transition: all 0.3s ease-out;-ms-transition: all 0.3s ease-out;-o-transition: all 0.3s ease-out;transition: all 0.3s ease-out;opacity: 1;}
		.displayBlock { display: block; }
		.displayNone { display: none; }
		table.dataTable { margin-top: 2px !important; }
		.page-control { width: 210px !important; }
	</style>
</head>
<body>
	
	<!-- The table listing the files available for upload/download -->
    <table role="presentation" class="table table-striped table-file-details"><tbody class="files"></tbody></table><!-- style="display: none !important;" -->
    
    <apex:pageMessages escape="false" />
    <div class="" style=""><!-- container -->
    	<table id="cv_table" class="table table-striped1 table-bordered table-condensed" cellspacing="0" cellpadding="0" width="100%">
    		<thead>
    			<tr>
	    			<th class="">Action</th>
	    			<th class="">Title</th>
	    			<th class="">Type</th>
	    			<th class="">Category</th>
	    			<th class="">Description</th>
	    			<th class="">Tags</th>
	    			<th class="">Created Date</th>
	    			<th class="">Last Modified Date</th>
	    			<th class="" id="tableContentData_vercom">Versions</th>
    			</tr>
    		</thead>
    		<tbody>
    		<apex:repeat value="{!ContentVersionsList}" var="cv">
	    		<tr class="tb-data-row" id="{!LEFT(cv.Id,15)}">
	    			<td class="col1" nowrap="nowrap">
						<a href="javascript: parent.showPublishWindow('{!cv.Id}','{!JSINHTMLENCODE($currentPage.parameters.workid)}','{!JSINHTMLENCODE($currentPage.parameters.cat)}', '0', '1', '1', '', '');" class="actionLink"><img src="/img/func_icons/util/pencil12.gif" title="Edit" style="border:0px;" /></a>
						<apex:outputLink rendered="{!disableDragDrop == true || PortalEnabled == '1'}" value="javascript:void(0);" onclick="parent.showNewVersionWindow('{!cv.ContentDocumentId}','{!JSINHTMLENCODE($User.Id)}','{!JSINHTMLENCODE($CurrentPage.parameters.cat)}');" styleClass="actionLink"><img src="/img/content/contribute16.png" title="Upload New Version" style="border:0px;" /></apex:outputLink>
						<apex:outputLink rendered="{!disableDragDrop == false && PortalEnabled != '1'}" value="javascript:void(0);" onclick="showNewVersionUpload('{!LEFT(cv.Id,15)}');" styleClass="actionLink"><img src="/img/content/contribute16.png" title="Upload New Version" style="border:0px;" /></apex:outputLink>
						<!-- <a href="javascript: parent.showNewVersionWindow('{!cv.ContentDocumentId}','{!JSINHTMLENCODE($User.Id)}','{!JSINHTMLENCODE($CurrentPage.parameters.cat)}');" class="actionLink"><img src="/img/content/contribute16.png" title="Upload New Version" style="border:0px;" /></a>
						<a href="javascript: showNewVersionUpload('{!LEFT(cv.Id,15)}');" class="actionLink"><img src="/img/content/contribute16.png" title="Upload New Version" style="border:0px;" /></a> -->
						<a href="{!$Site.Prefix}/sfc/servlet.shepherd/version/download/{!cv.Id}?asPdf=false&operationContext=CHATTER" class="actionLink" target="_blank"><img src="/img/content/download16.png" title="Download" style="border:0px;" /></a>
						<a href="javascript: parent.showPreview('{!cv.Id}');"><img src="/img/s.gif" title="Preview" height="16" width="16" style="background: url('/img/chatterfiles/chatterfiles16_sprite.png') no-repeat scroll 0 0 transparent !important;border:0px;" /></a>
	    			</td>
	    			<td class="col2 ellipsis col_title_{!LEFT(cv.Id,15)}">
	    				<div class="linkTD_{!LEFT(cv.ContentDocumentId,15)}" id="linkTD_{!LEFT(cv.Id,15)}" data-verId="{!LEFT(cv.Id,15)}"><a href="/{!cv.Id}" target="_blank" title="{!cv.Title} [Open in New Window]">{!cv.Title}</a></div>
	    				<div class="hide" id="uploadTD_{!LEFT(cv.Id,15)}">
							<!-- The file upload form used as target for the file upload widget -->
						    <form class="fileupload_version_{!LEFT(cv.Id,15)}" id="fileupload_version_{!LEFT(cv.Id,15)}" action="{!$Site.Prefix}/sfc/servlet.shepherd" method="POST" enctype="multipart/form-data">
						        <!-- Redirect browsers with JavaScript disabled to the origin page -->
						        <noscript><input type="hidden" name="redirect" value="/home/home.jsp" /></noscript>
						        <div class="">
									<div class="row">
						           		<div class="col-xs-12">
						           			<div class="fileupload-progress fileupload-progress_{!LEFT(cv.Id,15)} fade hide">
								                <!-- The global progress bar -->
								                <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100">
								                    <div class="progress-bar progress-bar-success" style="width:0%;"></div>
								                </div>
								                <!-- The extended global progress information -->
								                <div class="progress-extended">&nbsp;</div>
								            </div>
								            <div class="text-reason-change hide" id="text-reason-change_container_{!LEFT(cv.Id,15)}">
								            	<input type="text" class="form-control input-sm" id="text-reason-change_{!LEFT(cv.Id,15)}" placeholder="Reason for change..." />
								            </div>
								      	</div>
								   	</div>
								   	<div class="row">
								   		<div class="col-xs-12">
						                	<!-- The global progress information -->
								            <div class="fileupload-buttonbar" style="margin-top: 2px;">
								                <!-- The fileinput-button span is used to style the file input field as button -->
										  		<span class="btn btn-success btn-xs fileinput-button button-add" id="button-add_{!LEFT(cv.Id,15)}">
								                    <i class="glyphicon glyphicon-plus"></i>
								                    <span>Add file...</span>
								                    <input type="file" name="files[]" multiple="multiple" />
								                </span>
								                <button type="submit" class="btn btn-primary btn-xs start button-start" id="button-start_{!LEFT(cv.Id,15)}">
								                    <i class="glyphicon glyphicon-upload"></i>
								                    <span>Start</span>
								                </button>
								                <button type="reset" class="btn btn-danger btn-xs cancel button-cancel hide" id="button-cancel_{!LEFT(cv.Id,15)}">
								                    <i class="glyphicon glyphicon-ban-circle"></i>
								                    <span>Cancel</span>
								                </button>
								                <!-- The loading indicator is shown during file processing -->
								                <span class="fileupload-loading"></span>
								            </div>
								    	</div>
							    	</div>
							    </div>
							</form>
						</div>
	    			</td>
	    			<td class="col3 ellipsis">{!cv.Type__c}</td>
	    			<td class="col4 ellipsis">{!cv.Category__c}</td>
	    			<td class="col5 ellipsis">{!cv.Description}</td>
	    			<td class="col6 ellipsis">{!cv.TagCsv}</td>
	    			<td class="col7 ellipsis" nowrap="nowrap"><apex:outputText value="{0,date,yyyy-MM-dd HH:mm a}"><apex:param value="{!cv.CreatedDate}" /></apex:outputText></td>
	    			<td class="col8 ellipsis" nowrap="nowrap"><apex:outputText value="{0,date,yyyy-MM-dd HH:mm a}"><apex:param value="{!cv.LastModifiedDate}" /></apex:outputText></td>
	    			<td class="col9" align="center"><a href="javascript: parent.showAllVersionWindow('{!cv.ContentDocumentId}');" class="actionLink" title="Click to View Version Details">{!cv.VersionNumber}</a></td>
	    		</tr>
	    	</apex:repeat>
    		</tbody>
    	</table>
  	</div>
<!-- The template to display files available for upload -->
<script id="template-upload" type="text/x-tmpl">
{% for (var i=0, file; file=o.files[i]; i++) { %}
    <tr class="template-upload fade">
        <td>
            <span class="preview"></span>
        </td>
        <td>
            <p class="name">{%=file.name%}</p>
            {% if (file.error) { %}
                <div><span class="label label-danger">Error</span> {%=file.error%}</div>
            {% } %}
        </td>
        <td>
            <p class="size">{%=o.formatFileSize(file.size)%}</p>
            {% if (!o.files.error) { %}
                <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><div class="progress-bar progress-bar-success" style="width:0%;"></div></div>
            {% } %}
        </td>
        <td>
            {% if (!o.files.error && !i && !o.options.autoUpload) { %}
                <button class="btn btn-primary start">
                    <i class="glyphicon glyphicon-upload"></i>
                    <span>Start</span>
                </button>
            {% } %}
            {% if (!i) { %}
                <button class="btn btn-warning cancel">
                    <i class="glyphicon glyphicon-ban-circle"></i>
                    <span>Cancel</span>
                </button>
            {% } %}
        </td>
    </tr>
{% } %}
</script>
<!-- The template to display files available for download -->
<script id="template-download" type="text/x-tmpl">
{% for (var i=0, file; file=o.files[i]; i++) { %}
    <tr class="template-download fade">
        <td>
            <span class="preview">
                {% if (file.thumbnailUrl) { %}
                    <a href="{%=file.url%}" title="{%=file.name%}" download="{%=file.name%}" data-gallery><img src="{%=file.thumbnailUrl%}"></a>
                {% } %}
            </span>
        </td>
        <td>
            <p class="name">
                {% if (file.url) { %}
                    <a href="{%=file.url%}" title="{%=file.name%}" download="{%=file.name%}" {%=file.thumbnailUrl?'data-gallery':''%}>{%=file.name%}</a>
                {% } else { %}
                    <span>{%=file.name%}</span>
                {% } %}
            </p>
            {% if (file.error) { %}
                <div><span class="label label-danger">Error</span> {%=file.error%}</div>
            {% } %}
        </td>
        <td>
            <span class="size">{%=o.formatFileSize(file.size)%}</span>
        </td>
        <td>
            {% if (file.deleteUrl) { %}
                <button class="btn btn-danger delete" data-type="{%=file.deleteType%}" data-url="{%=file.deleteUrl%}"{% if (file.deleteWithCredentials) { %} data-xhr-fields='{"withCredentials":true}'{% } %}>
                    <i class="glyphicon glyphicon-trash"></i>
                    <span>Delete</span>
                </button>
                <input type="checkbox" name="delete" value="1" class="toggle">
            {% } else { %}
                <button class="btn btn-warning cancel">
                    <i class="glyphicon glyphicon-ban-circle"></i>
                    <span>Cancel</span>
                </button>
            {% } %}
        </td>
    </tr>
{% } %}
</script>

<!-- The jQuery UI widget factory, can be omitted if jQuery UI is already included -->
<apex:includeScript value="{!URLFOR($Resource.advpm__jQuery_FileUpload, 'jQuery-File-Upload-9.5.7/js/vendor/jquery.ui.widget.js')}" />
<!-- The Templates plugin is included to render the upload/download listings -->
<apex:includeScript value="{!URLFOR($Resource.advpm__jQuery_FileUpload_Templates, 'JavaScript-Templates-2.4.0/js/tmpl.min.js')}" />
<!-- The Load Image plugin is included for the preview images and image resizing functionality -->
<apex:includeScript value="{!URLFOR($Resource.advpm__jQuery_FileUpload_LoadImage, 'JavaScript-Load-Image-1.9.1/js/load-image.min.js')}" />
<!-- The Canvas to Blob plugin is included for image resizing functionality -->
<apex:includeScript value="{!URLFOR($Resource.advpm__jQuery_FileUpload_CanvasToBlob, 'JavaScript-Canvas-to-Blob-2.0.7/js/canvas-to-blob.min.js')}" />
<!-- Bootstrap JS is not required, but included for the responsive demo navigation -->
<apex:includeScript value="{!URLFOR($Resource.advpm__MBView_Bootstrap, 'bootstrap-3.1.1/js/bootstrap.min.js')}" />
<!-- blueimp Gallery script -->
<!-- <apex:includeScript value="http://blueimp.github.io/Gallery/js/jquery.blueimp-gallery.min.js" /> -->

<!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
<apex:includeScript value="{!URLFOR($Resource.advpm__jQuery_FileUpload, 'jQuery-File-Upload-9.5.7/js/jquery.iframe-transport.js')}" />
<!-- The basic File Upload plugin -->
<apex:includeScript value="{!URLFOR($Resource.advpm__jQuery_FileUpload, 'jQuery-File-Upload-9.5.7/js/jquery.fileupload.js')}" />
<!-- The File Upload processing plugin -->
<apex:includeScript value="{!URLFOR($Resource.advpm__jQuery_FileUpload, 'jQuery-File-Upload-9.5.7/js/jquery.fileupload-process.js')}" />
<!-- The File Upload image preview & resize plugin -->
<apex:includeScript value="{!URLFOR($Resource.advpm__jQuery_FileUpload, 'jQuery-File-Upload-9.5.7/js/jquery.fileupload-image.js')}" />
<!-- The File Upload audio preview plugin -->
<apex:includeScript value="{!URLFOR($Resource.advpm__jQuery_FileUpload, 'jQuery-File-Upload-9.5.7/js/jquery.fileupload-audio.js')}" />
<!-- The File Upload video preview plugin -->
<apex:includeScript value="{!URLFOR($Resource.advpm__jQuery_FileUpload, 'jQuery-File-Upload-9.5.7/js/jquery.fileupload-video.js')}" />
<!-- The File Upload validation plugin -->
<apex:includeScript value="{!URLFOR($Resource.advpm__jQuery_FileUpload, 'jQuery-File-Upload-9.5.7/js/jquery.fileupload-validate.js')}" />
<!-- The File Upload user interface plugin -->
<apex:includeScript value="{!URLFOR($Resource.advpm__jQuery_FileUpload, 'jQuery-File-Upload-9.5.7/js/jquery.fileupload-ui.js')}" />
<!-- The main application script -->
<!-- <apex:includeScript value="{!URLFOR($Resource.jQuery_FileUpload, 'jQuery-File-Upload-9.5.7/js/main.js')}" /> -->

<!-- The XDomainRequest Transport is included for cross-domain file deletion for IE 8 and IE 9 -->
<!--[if (gte IE 8)&(lt IE 10)]>
<apex:includeScript value="{!URLFOR($Resource.jQuery_FileUpload, 'jQuery-File-Upload-9.5.7/js/cors/jquery.xdr-transport.js')}" />
<![endif]-->

<script type="text/javascript">
	$(document).bind('drop dragover', function (e) {
	    e.preventDefault();
	});
	$(document).bind('dragover', function (e) {
		$('.tb-data-row').each(function () {
			var $this = $(this);
			var dropZone = $this,
		        timeout = window.dropZoneTimeout;
		    if (!timeout) {
		        dropZone.addClass('in');
		    } else {
		        clearTimeout(timeout);
		    }
		    var found = false,
		      	node = e.target;
		    do {
		        if (node === dropZone[0]) {
		       		found = true;
		       		break;
		       	}
		       	node = node.parentNode;
		    } while (node != null);
		    if (found) {
		        dropZone.addClass('hover');
		    } else {
		        dropZone.removeClass('hover');
		    }
		    window.dropZoneTimeout = setTimeout(function () {
		        window.dropZoneTimeout = null;
		        dropZone.removeClass('in hover');
		    }, 100);
		});
	});
	function showNewVersionUpload(objId){
		//showNewVersionWindow('"+data.contentdocid+"','{!JSINHTMLENCODE($User.Id)}','{!JSINHTMLENCODE(selectedCategory)}');
		
		$('#linkTD_'+objId).addClass('hide');
		$('#uploadTD_'+objId).removeClass('hide');
		$('.fileupload-progress_'+objId).addClass('hide');
		$('#text-reason-change_container_'+objId).addClass('hide');
		$('#button-add_'+objId).removeClass('hide');
		$('#button-start_'+objId).addClass('hide');
		$('#button-cancel_'+objId).removeClass('hide');
		oTable.fnStandingRedraw();
	}
	function toggleUploadProgress(isUploading, isInitiated, objId){
		if (isUploading && !isInitiated){
			$('#linkTD_'+objId).addClass('hide');
			$('#uploadTD_'+objId).removeClass('hide');
			$('.fileupload-progress_'+objId).removeClass('hide');
			$('#text-reason-change_container_'+objId).addClass('hide');
			$('#button-add_'+objId).addClass('hide');
			$('#button-start_'+objId).addClass('hide');
			$('#button-cancel_'+objId).removeClass('hide');
		}
		else if (!isUploading && isInitiated){
			$('#linkTD_'+objId).addClass('hide');
			$('#uploadTD_'+objId).removeClass('hide');
			$('.fileupload-progress_'+objId).addClass('hide');
			$('#text-reason-change_container_'+objId).removeClass('hide');
			$('#button-add_'+objId).addClass('hide');
			$('#button-start_'+objId).removeClass('hide');
			$('#button-cancel_'+objId).removeClass('hide');
		}
		else {
			$('#linkTD_'+objId).removeClass('hide');
			$('#uploadTD_'+objId).addClass('hide');
			$('.fileupload-progress_'+objId).addClass('hide');
			$('#text-reason-change_container_'+objId).removeClass('hide');
			$('#button-add_'+objId).removeClass('hide');
			$('#button-start_'+objId).addClass('hide');
			$('#button-cancel_'+objId).addClass('hide');
			
			$('#'+objId).removeClass('hover');
			$('#'+objId).removeClass('in');
		}
		if ($('#text-reason-change_'+objId).HasBubblePopup())
			$('#text-reason-change_'+objId).RemoveBubblePopup();
		//console.log('..isUploading ['+isUploading+']: '+objId+' - '+$('#uploadTD_'+objId).attr('id'));
	}
	var filesDoneCount = 0;
   	var filesTotalCount = 0;
   	var contentIDsArr = [];
	function attachDragDropVersions()
	{
		$(".table-file-details").hide();
	    filesDoneCount = 0;
    	filesTotalCount = 0;
    	contentIDsArr = [];
		$('.tb-data-row').each(function () {
			var $this = $(this);
			//console.log('row : '+$this.attr('id'));
			$("#button-cancel_"+$this.attr('id')).click(function(e) {
				toggleUploadProgress(false, false, $this.attr('id'));
				filesDoneCount = 0;
		    	filesTotalCount = 0;
		    	contentIDsArr = [];
			});
			$("#button-add_"+$this.attr('id')).click(function(e) {
				toggleUploadProgress(false, true, $this.attr('id'));
				filesDoneCount = 0;
		    	filesTotalCount = 0;
		    	contentIDsArr = [];
			});
			
		    // Initialize the jQuery File Upload widget: 
		    $('#fileupload_version_'+$this.attr('id')).fileupload({
		    	dropZone: $this,
		    	drop: function (e, data) {
				    //console.log('dropped : '+JSON.stringify(data));
				},
		        // Uncomment the following to send cross-domain cookies:
		        //xhrFields: {withCredentials: true},
		        forceIframeTransport: false,
		        url: '{!$Site.Prefix}/sfc/servlet.shepherd',
		        //autoUpload: true,
		        //maxNumberOfFiles: 1,
		        add: function(e, data) { 
		        	filesTotalCount = filesTotalCount + data.files.length;
		        	//console.log('[add] filesTotalCount: '+filesTotalCount);
		        	if (filesTotalCount > 1)
		        	{
		        		addMultiFileErrorTooltip($this.attr('id'));
		        	}
		        	else
		        	{
			        	var versionId = $this.attr('id');
			        	//console.log('file added: '+JSON.stringify(data));
			        	toggleUploadProgress(false, true, versionId);
			            // get Shepherd create token
			            jQuery.post(
			                '{!$Site.Prefix}/sfc/servlet.shepherd', 
			                { 
			                	message: JSON.stringify({
			                		"actions":[{
			                			"controller":"view",
			                			"action":"show",
			                			"params":{
			                				"views":[{
			                					"container":"container_bubble",
			                					"page":"contributeDocument",
			                					"params":{"selectedVersionId":versionId,"publishType":"DocumentContentChange"}
			                				}]
			                			}
			                		}]
			                	}),
			                	format: 'json',
			                	_: ''
			                }, 
			                function(resp) {
			                    //console.log('[add] resp: '+JSON.stringify(resp));
			                    //console.log('[add] content: '+resp.actions[0].params.views[0].content);
			                    var content = resp.actions[0].params.views[0].content;
			                    var elements = $(content);
								var shepTokenEl = $('#shepherdToken', elements);
								//console.log('[add] shepherdToken: '+shepTokenEl.val());
								var shepToken = shepTokenEl.val();
								var docIdEl = $('#selectedDocumentId', elements);
								//console.log('[add] docId: '+docIdEl.val());
								var docId = docIdEl.val();
								
								data.formData = {
			                        file: data.files[0],
			                        message: JSON.stringify({
			                        	"actions":[{
			                       			"controller":"document",
			                       			"action":"create",
			                       			"params": {
			                       					"selectedDocumentId":docId,
			                       					"selectedWorkspaceId":"",
			                       					"shepherdToken":shepToken,
			                       					"file":data.files[0].name,
			                       					"pathOnClient":data.files[0].name,
			                       					"title":data.files[0].name.split('.')[0],
			                       					"formId":"fileSelectForm",
			                       					"shepherdFormName":"fileSelectForm"
			                       			}
			                        	}]
			                        }),
			                        shepherdToken: shepToken,
			                        selectedWorkspaceId: '',
			                        selectedDocumentId: docId,
			                        format: 'json'
			                    }
			                    
			                    //data.submit();
			                    $("#button-start_"+versionId).on('click', function () {
									if ($('#text-reason-change_'+versionId).val()=='')
									{
										alert('Reason for Change must be provided.');
									} 
									else
									{
										toggleUploadProgress(true, false, versionId);
							            data.submit();
						            }
						        });
			                }
			            );
			            // now carry on with original add function
			            $.blueimp.fileupload.prototype.options.add.call(this, e, data);
			    	}
		        },
		        always: function () {
			        $(this).removeClass('fileupload-processing');
			    },
			    done: function (e, data) {
			        var resp = jQuery.parseJSON( JSON.stringify( data.result ) );
			        //console.log('[done] resp: '+JSON.stringify( resp ));
			        var versionId = resp.actions[0].params.versionId;
			        //console.log('[done] versionId: '+versionId);
			        var documentId = resp.actions[0].params.documentId;
			        //console.log('[done] documentId: '+documentId);
			        
			        jQuery.post(
		                '{!$Site.Prefix}/sfc/servlet.shepherd', 
		                { 
		                	message: JSON.stringify({
		                		"actions":[{
		                			"controller":"view",
		                			"action":"show",
		                			"params":{
		                				"views":[{
		                					"container":"ext-gen71",
		                					"page":"documentUpdate",
		                					"params":{
		                						"selectedVersionId": versionId,
		                						"publishType":"New"
		                					}
		                				}]
		                			}
		                		}]
		                	}),
			                format: 'json',
		                	_: ''
		                },
		                function(resp) {
		                    //console.log('[done] resp: '+JSON.stringify(resp));
		                    //console.log('[done] content: '+resp.actions[0].params.views[0].content);
		                    var content = resp.actions[0].params.views[0].content;
		                    var elements = $(content);
							var shepTokenEl = $('#shepherdToken', elements);
							//console.log('[done] shepherdToken: '+shepTokenEl.val());
							var shepToken = shepTokenEl.val();
							var CSRFTokenEl = $('#contributeCancelCSRFToken', elements);
							//console.log('[done] CSRFToken: '+CSRFTokenEl.val());
							var CSRFToken = CSRFTokenEl.val();
							var titleEl = $('#title', elements);
							//console.log('[done] title: '+titleEl.val());
							var title = titleEl.val();
							
							jQuery.post(
				                '{!$Site.Prefix}/sfc/servlet.shepherd', 
				                { 
				                	message: JSON.stringify({
									   "actions":[{
									         "controller":"document",
									         "action":"updateAndPublish",
									         "params":{
									            "title":$('#linkTD_'+$('.linkTD_'+documentId).attr('data-verId')).find('a').text(),
									            "description":"",
									            "reasonForChange": $('#text-reason-change_'+$('.linkTD_'+documentId).attr('data-verId')).val(),
									            "contributeCancelCSRFToken":CSRFToken,
									            "canPublishIntoPublicWorkspace":"false",
									            "sharingRadio":"sharedWSRadio",
									            "tagField":[
									
									            ],
									            "properties":{
									               
									            },
									            "versionId":versionId,
									            "publishType":"DocumentContentChange",
									            "publishStatus":"U",
									            "displayWorkspaces":"false",
									            "shepherdToken":shepToken,
									            "activeTabId":"contributeTab"+versionId,
									            "shepherdFormName":"uploadEditForm"+versionId
									         }
										}]
									}),
					                format: 'json',
				                	_: ''
				                },
				                function(resp) {
				                	filesDoneCount	= filesDoneCount + 1;
				                    contentIDsArr.push( versionId );
				                    //console.log('[done - '+filesDoneCount+'] resp: '+JSON.stringify(resp));
				                    //console.log('[done] content: '+resp.actions[0].params.views[0].content);
				                    //console.log('[COMPLETE] uploaded files: '+filesDoneCount);
				                    toggleUploadProgress(false, false, $('.linkTD_'+documentId).attr('data-verId'));
				                    parent.RefreshDisplay('', '', contentIDsArr.join(), true, false, contentIDsArr.length, '', '');
				                }
				            );
		                }
		            );
			    }
		    });
		});
	}
	$(function () {
	    'use strict';
	    bind_dataTable();
	    bindTooltip();
	});
	var oTable;
	function bind_dataTable()
	{
		$.fn.dataTableExt.oApi.fnStandingRedraw = function(oSettings) {
		    if(oSettings.oFeatures.bServerSide === false){
		        var before = oSettings._iDisplayStart;
		 
		        oSettings.oApi._fnReDraw(oSettings);
		 
		        // iDisplayStart has been reset to zero - so lets change it back
		        oSettings._iDisplayStart = before;
		        oSettings.oApi._fnCalculateEnd(oSettings);
		    }
		      
		    // draw the 'current' page
		    oSettings.oApi._fnDraw(oSettings);
		};
		/* Table initialisation */
		oTable = $('#cv_table').dataTable({
			"sDom": "<'row'<'col-xs-4'l><'col-xs-8'f>r>t<'row'<'col-xs-4'i><'col-xs-8'p>>",
			"sScrollY": ('{!JSINHTMLENCODE($CurrentPage.parameters.p)}' == '1'? (0.6 * $(window).height()) : '170'),
			"sScrollX": "100%",
			"bAutoWidth": false,
    		"bScrollCollapse": false,
			"iDisplayLength": {!IF(JSINHTMLENCODE($CurrentPage.parameters.p) == '1', '15', '5')},
			"aLengthMenu": [[5, 10, 15, 25, 50, 100], [5, 10, 15, 25, 50, 100]],
			"oLanguage": { 
				"sSearch": "",
				"sLengthMenu": '<select>'+
						       '<option value="5">Show&nbsp;&nbsp;&nbsp;5&nbsp;&nbsp;&nbsp;records per page</option>'+
						       '<option value="10">Show&nbsp;&nbsp;10&nbsp;&nbsp;records per page</option>'+
						       '<option value="15">Show&nbsp;&nbsp;15&nbsp;&nbsp;records per page</option>'+
						       '<option value="25">Show&nbsp;&nbsp;25&nbsp;&nbsp;records per page</option>'+
						       '<option value="50">Show&nbsp;&nbsp;50&nbsp;&nbsp;records per page</option>'+
						       '<option value="100">Show&nbsp;100&nbsp;records per page</option>'+
						       '</select>'
			},
			"aoColumns": [
				{ "sType": "html", "bSortable": false, "bSearchable": false },
				{ "sType": "html" },
				{ "sType": "string" },
				{ "sType": "string" },
				{ "sType": "string" },
				{ "sType": "string", "bSortable": false },
				{ "sType": "html", "bSearchable": false },
				{ "sType": "html", "bSearchable": false },
				{ "sType": "html", "bSearchable": false }
			],
			"fnDrawCallback": function( oSettings ) {
		    	attachDragDropVersions();
		    }
		});
		oTable.fnSort( [[ 6,'desc' ]] );
		oTable.fnStandingRedraw();
		$('#cv_table_filter input').addClass('form-control input-sm').attr('placeholder', 'Search here...');
		$('#cv_table_length select').addClass('form-control input-sm page-control');
		setTimeout(function () {
	        oTable.fnPageChange("first");
	    }, 200);
	}
	function bindTooltip()
	{
		if ({!disableDragDrop}){
			$('#tableContentData_vercom').CreateBubblePopup({
												selectable		: false,
												position 		: 'left',
												width			: '310px',
												innerHtml		: 'Value greater than 1 indicates that the file has been revised that number of times.',
												innerHtmlStyle	: {
														 color  : '#ffffff'
												},
												themeName		: "all-azure",
												themePath		: "{!URLFOR($Resource.jQuery_BubblePopup, '/Install/jquerybubblepopup-theme/')}"
											});
		}
		else {
			$('#tableContentData_vercom').CreateBubblePopup({
												selectable		: false,
												position 		: 'left',
												width			: '310px',
												innerHtml		: 'Value greater than 1 indicates that the file has been revised that number of times.<br/><br/><i>To upload <b><u>new version</u></b> for a file just <b><u>drag-n-drop</u></b> the file on the respective row in the grid.</i>',
												innerHtmlStyle	: {
														 color  : '#ffffff'
												},
												themeName		: "all-azure",
												themePath		: "{!URLFOR($Resource.jQuery_BubblePopup, '/Install/jquerybubblepopup-theme/')}"
											});
		}
	}
	function addMultiFileErrorTooltip(objId)
	{
		$('#text-reason-change_'+objId).CreateBubblePopup({
											selectable		: false,
											position 		: 'top',
											width			: '310px',
											innerHtml		: 'Multiple files cannot be dropped here! First file in the list has been used for upload at this point.',
											innerHtmlStyle	: {
													 color  : '#ffffff'
											},
											themeName		: "all-black",
											themePath		: "{!URLFOR($Resource.jQuery_BubblePopup, '/Install/jquerybubblepopup-theme/')}"
									  });
	}
</script>
</body>
</html>
</apex:page>